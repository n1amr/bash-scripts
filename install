#!/bin/sh

set -e

DOTFILES_HOME="$(realpath "$(dirname "$0")")"
DST_HOME="$HOME"
interactive=true

while [ $# != 0 ]; do
    case "$1" in
        --user-home)      DST_HOME="$2";      shift ;;
        --dotfiles-path)  DOTFILES_HOME="$2"; shift ;;
        --no-interactive) interactive=false ;;
        *)
            echo 'Invalid Syntax'
            exit 1
        ;;
    esac
    shift
done

if [ -f "~/.dotfiles_config" ]; then
    . "~/.dotfiles_config"
fi

if [ "$interactive" = 'true' ]; then
    # Set DST_HOME
    printf "Enter your home directory [%s]: " "$DST_HOME"
    read -r response
    if [ ! -z "$response" ]; then
        DST_HOME="$(realpath "$response")"
    fi

    # Set DOTFILES_HOME
    printf "Enter dofiles directory [%s]: " "$DOTFILES_HOME"
    read -r response
    if [ ! -z "$response" ]; then
        DOTFILES_HOME="$(realpath "$response")"
    fi
fi

DOTFILES_DIR="$DST_HOME/.dotfiles"
if [ ! -d "$DOTFILES_DIR" ]; then
    if [ -e "$DOTFILES_DIR" ]; then
        mv "$DOTFILES_DIR" "${DOTFILES_DIR}.bak.$(date +%s)"
    fi
    ln -sf "$DOTFILES_HOME" "$DOTFILES_DIR"
    DOTFILES_HOME="$DOTFILES_DIR"
fi

DOTFILES_DATA_DIR="$DOTFILES_HOME/data"
mkdir -pv "$DOTFILES_DATA_DIR"
mkdir -pv "$DOTFILES_DATA_DIR/history"
touch "$DOTFILES_DATA_DIR/history/zsh_history"

DOTFILES_CONFIG_FILE="$DOTFILES_DATA_DIR/dotfiles_config"

safe_link() {
    from="$1"
    to="$2"

    if [ "$interactive" = 'true' ]; then
        printf "Link %s -> %s ? ([y]/n) " "$from" "$to"
        read -r response
    else
        response='y'
    fi

    if [ "$response" != 'n' ]; then
        if [ -e "$from" ]; then
            echo mv "$from" "${from}.bak.$(date +%s)"
            mv "$from" "${from}.bak.$(date +%s)"
        fi

        dir="$(dirname "$from")"
        if [ ! -d "$dir" ]; then
            mkdir -pv "$dir"
        fi

        ln -sf "$to" "$from"
    fi
}

config_files="
    driverc
    emacs
    emacs.d
    gitconfig
    gitignore
    inputrc
    irbrc
    sqliterc
    tmux.conf
    vim
    wgetrc
    xinitrc
"

for cf in $config_files; do
    safe_link "$DST_HOME/.$cf" "$DOTFILES_HOME/config/$cf"
done

for cf in bashrc zshrc; do
    safe_link "$DST_HOME/.$cf" "$DOTFILES_HOME/config/shellrc"
done

custom_install="$DOTFILES_DATA_DIR/custom_install"
if [ -x "$custom_install" ]; then
    export interactive
    export DST_HOME
    export DOTFILES_HOME
    "$custom_install"
fi

safe_link "$DST_HOME/.config/autostart" "$DOTFILES_HOME/config/autostart"
safe_link "$DST_HOME/.config/i3" "$DOTFILES_HOME/config/i3"
safe_link "$DST_HOME/.config/ranger" "$DOTFILES_HOME/config/ranger"
safe_link "$DST_HOME/.config/vlc" "$DOTFILES_HOME/config/vlc"
safe_link "$DST_HOME/.dotfiles_config" "$DOTFILES_CONFIG_FILE"
safe_link "$DST_HOME/.ipython/profile_default" "$DOTFILES_HOME/config/ipython/profile_default"
safe_link "$DST_HOME/.irssi" "$DOTFILES_HOME/config/irssi"
safe_link "$DST_HOME/.vimrc" "$DOTFILES_HOME/config/vim/vimrc"
safe_link "$DST_HOME/.zsh_history.bak" "$DOTFILES_DATA_DIR/history/zsh_history"

# oh-my-zsh custom config
safe_link "$DOTFILES_HOME/thirdparty/oh-my-zsh/custom/themes/n1amr.zsh-theme" ../../../../config/n1amr.zsh-theme
cd "$DOTFILES_HOME/config/zsh-plugins"
for plugin in *; do
    safe_link "$DOTFILES_HOME/thirdparty/oh-my-zsh/custom/plugins/$plugin" "../../../../config/zsh-plugins/$plugin"
done
cd -

cat >> "$DOTFILES_CONFIG_FILE" <<EOF
#!/bin/bash

export DOTFILES_HOME='$DOTFILES_HOME'
export PYENV_ROOT='$DST_HOME/.pyenv'
export RBENV_ROOT='$DST_HOME/.rbenv'
EOF

chmod +x "$DOTFILES_CONFIG_FILE"

echo "Contents of config file at $DOTFILES_CONFIG_FILE:"
echo "===== Start ====="
cat "$DOTFILES_CONFIG_FILE"
echo "===== End ====="

# fzf install
if [ "$interactive" = 'true' ]; then
    "$DOTFILES_HOME/thirdparty/fzf/install"
else
    "$DOTFILES_HOME/thirdparty/fzf/install" --all
fi

echo "Successful!"
if [ "$interactive" = 'true' ]; then
    exec "$SHELL"
fi
