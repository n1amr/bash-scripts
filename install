#!/bin/sh

CONFIG_FILE=`realpath ~/.dotfiles_config`
if [ -f "${CONFIG_FILE}" ]; then
    . "${CONFIG_FILE}"
fi

# Set MY_HOME
MY_HOME="${HOME}"
echo -n "Enter your home directory [${MY_HOME}]: "
read response
if [ ! -z "${response}" ]; then
    MY_HOME=`realpath "${response}"`
fi

# Set DOTFILES_ROOT
DOTFILES_ROOT=`realpath .`
echo -n "Enter dofiles directory [${DOTFILES_ROOT}]: "
read response
if [ ! -z "${response}" ]; then
    DOTFILES_ROOT=`realpath "${response}"`
fi

DOTFILES_DIR="$MY_HOME/.dotfiles"
if [ ! -d "$DOTFILES_DIR" ]; then
    if [ -e "$DOTFILES_DIR" ]; then
        mv "$DOTFILES_DIR" "${DOTFILES_DIR}.bak.$(date +%s)"
    fi
    ln -sf "$DOTFILES_ROOT" "$DOTFILES_DIR"
    DOTFILES_ROOT="$DOTFILES_DIR"
fi

safe_link() {
    from="$1"
    to="$2"
    echo -n "Link ${from} -> ${to} ? [y/n]"
    read response

    if [ x"${response}" != xn ]; then
        if [ -e "$from" ]; then
            echo mv "$from" "${from}.bak.$(date +%s)"
            mv "$from" "${from}.bak.$(date +%s)"
        fi

        dir=`dirname "${from}"`
        if [ ! -d "${dir}" ]; then
            mkdir -pv "${dir}"
        fi

        ln -sf "${to}" "${from}"
    fi
}

for cf in gitconfig gitignore inputrc irbrc sqliterc vim vimrc; do
    safe_link ~/."${cf}" "${DOTFILES_ROOT}/config/${cf}"
done

for cf in bashrc zshrc; do
    safe_link ~/."${cf}" "${DOTFILES_ROOT}/config/shellrc"
done

for cf in netrc trc; do
    safe_link ~/."${cf}" "${DOTFILES_ROOT}/config/secret/${cf}"
done

safe_link "${DOTFILES_ROOT}/config/oh-my-zsh/custom/themes/n1amr.zsh-theme" ../../../n1amr.zsh-theme
safe_link ~/".ipython/profile_default" "${DOTFILES_ROOT}/config/ipython/profile_default"

echo "#!/bin/bash" >> "$CONFIG_FILE"
echo "export MY_HOME='${MY_HOME}'" >> "$CONFIG_FILE"
echo "export DOTFILES_ROOT='${DOTFILES_ROOT}'" >> "$CONFIG_FILE"

echo
echo "Contents of config file at $CONFIG_FILE:"
echo
cat "$CONFIG_FILE"

exec "$SHELL"
