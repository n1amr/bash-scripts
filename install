#!/bin/sh

set -e

if [ -f "~/.dotfiles_config" ]; then
    . "~/.dotfiles_config"
fi

# Set DST_HOME
DST_HOME="$HOME"
printf "Enter your home directory [%s]: " "$DST_HOME"
read -r response
if [ ! -z "$response" ]; then
    DST_HOME="$(realpath "$response")"
fi

# Set DOTFILES_HOME
DOTFILES_HOME="$(realpath .)"
printf "Enter dofiles directory [%s]: " "$DOTFILES_HOME"
read -r response
if [ ! -z "$response" ]; then
    DOTFILES_HOME="$(realpath "$response")"
fi

DOTFILES_DIR="$DST_HOME/.dotfiles"
if [ ! -d "$DOTFILES_DIR" ]; then
    if [ -e "$DOTFILES_DIR" ]; then
        mv "$DOTFILES_DIR" "${DOTFILES_DIR}.bak.$(date +%s)"
    fi
    ln -sf "$DOTFILES_HOME" "$DOTFILES_DIR"
    DOTFILES_HOME="$DOTFILES_DIR"
fi

DOTFILES_DATA_DIR="$DOTFILES_HOME/data"
mkdir -pv "$DOTFILES_DATA_DIR"
mkdir -pv "$DOTFILES_DATA_DIR/history"
touch "$DOTFILES_DATA_DIR/history/zsh_history"

DOTFILES_CONFIG_FILE="$DOTFILES_DATA_DIR/dotfiles_config"


safe_link() {
    from="$1"
    to="$2"
    printf "Link %s -> %s ? ([y]/n) " "$from" "$to"
    read -r response

    if [ "$response" != 'n' ]; then
        if [ -e "$from" ]; then
            echo mv "$from" "${from}.bak.$(date +%s)"
            mv "$from" "${from}.bak.$(date +%s)"
        fi

        dir="$(dirname "$from")"
        if [ ! -d "$dir" ]; then
            mkdir -pv "$dir"
        fi

        ln -sf "$to" "$from"
    fi
}

config_files="
    driverc
    gitconfig
    gitignore
    inputrc
    irbrc
    sqliterc
    tmux.conf
    vim
    wgetrc
"

for cf in $config_files; do
    safe_link "$DST_HOME/.$cf" "$DOTFILES_HOME/config/$cf"
done

for cf in bashrc zshrc; do
    safe_link "$DST_HOME/.$cf" "$DOTFILES_HOME/config/shellrc"
done

for cf in netrc trc; do
    safe_link "$DST_HOME/.$cf" "$DOTFILES_HOME/config/secret/$cf"
done

safe_link "$DST_HOME/.config/i3" "$DOTFILES_HOME/config/i3"
safe_link "$DST_HOME/.config/ranger" "$DOTFILES_HOME/config/ranger"
safe_link "$DST_HOME/.dotfiles_config" "$DOTFILES_CONFIG_FILE"
safe_link "$DST_HOME/.ipython/profile_default" "$DOTFILES_HOME/config/ipython/profile_default"
safe_link "$DST_HOME/.vimrc" "$DOTFILES_HOME/config/vim/vimrc"
safe_link "$DST_HOME/.zsh_history.bak" "$DOTFILES_DATA_DIR/history/zsh_history"

# oh-my-zsh custom config
safe_link "$DOTFILES_HOME/thirdparty/oh-my-zsh/custom/themes/n1amr.zsh-theme" ../../../../config/n1amr.zsh-theme
cd "$DOTFILES_HOME/config/zsh-plugins"
for plugin in *; do
    safe_link "$DOTFILES_HOME/thirdparty/oh-my-zsh/custom/plugins/$plugin" "../../../../config/zsh-plugins/$plugin"
done
cd -

cat >> "$DOTFILES_CONFIG_FILE" <<EOF
#!/bin/bash

export DOTFILES_HOME='$DOTFILES_HOME'
export PYENV_ROOT='$DST_HOME/.pyenv'
export RBENV_ROOT='$DST_HOME/.rbenv'
EOF

chmod +x "$DOTFILES_CONFIG_FILE"

echo "Contents of config file at $DOTFILES_CONFIG_FILE:"
echo "===== Start ====="
cat "$DOTFILES_CONFIG_FILE"
echo "===== End ====="

# fzf install
"$DOTFILES_HOME/thirdparty/fzf/install"

echo "Successful!"
exec "$SHELL"
