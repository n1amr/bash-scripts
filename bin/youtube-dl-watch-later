#!/bin/bash

set -e

source ~/.dotfiles_config
source "$DOTFILES_HOME/bin/utils/log"
source "$DOTFILES_HOME/bin/utils/lock"

if [ -z "$DOTFILES_CONFIG_YOUTUBE_HOME" ]; then
    echo -n 'Enter youtube home directory: '
    read -r DOTFILES_CONFIG_YOUTUBE_HOME
    echo "export DOTFILES_CONFIG_YOUTUBE_HOME='$DOTFILES_CONFIG_YOUTUBE_HOME'" >> ~/.dotfiles_config
fi

YOUTUBE_DOWNLADER="$PYENV_ROOT/shims/youtube-dl"
YOUTUBE_HOME="$DOTFILES_CONFIG_YOUTUBE_HOME"

PLAYLIST='WL'
URL="https://youtube.com/playlist?list=$PLAYLIST"

if [ ! -d "$YOUTUBE_HOME/.youtube-dl/" ]; then
    mkdir "$YOUTUBE_HOME/.youtube-dl/"
fi

COOKIE_FILE="$YOUTUBE_HOME/.youtube-dl/cookies.txt"
ARCHIVE_FILE="$YOUTUBE_HOME/.youtube-dl/archive"

if [ ! -f "$COOKIE_FILE" ]; then
    echo "Please copy cookies.txt into '$COOKIE_FILE'"
    exit 1
fi

LOCK_FILE="$YOUTUBE_HOME/.youtube-dl/lock"
has_lock=false

cleanup () {
    echo 'Exiting'
    [ "$has_lock" = true ] && release_lock "$LOCK_FILE"
}
trap 'cleanup' EXIT INT

acquire_lock "$LOCK_FILE" && has_lock=true || exit 1

ARGS=()
ARGS+=(-f 18)
ARGS+=(--sub-lang en,ar --write-auto-sub --convert-subs srt)
ARGS+=(--continue --ignore-errors)
ARGS+=(--mark-watched)
ARGS+=(--cookie "$COOKIE_FILE")
ARGS+=(--download-archive "$ARCHIVE_FILE")
ARGS+=(-o '%(title)s - (@%(uploader)s - %(id)s).%(ext)s')
ARGS+=(--exec 'file={}; noext="${file%.*}"; for f in "$noext".*; do mv "$f" "$(date +%s). $f"; done')
ARGS+=("$URL")

cd "$YOUTUBE_HOME"
"$YOUTUBE_DOWNLADER" "${ARGS[@]}"
