#!/bin/bash

source ~/.dotfiles_config
source "$DOTFILES_HOME/bin/lib/log"
PATH="$DOTFILES_HOME/bin:$PATH"

WIFI_LIST_FILE="$DOTFILES_HOME/custom/config/dotfiles/wifi-check-list"
[ -f "$WIFI_LIST_FILE" ] || echo "# Enter wifi SSID list here" > "$WIFI_LIST_FILE"

DEVICE="$(nmcli dev | grep wifi | cut -d ' ' -f 1)"

status() {
    nmcli d | grep "$DEVICE" | grep -Po '\S*connected'
}

active_connection() {
    nmcli --fields DEVICE,NAME con show --active | grep -Po "(?<=$DEVICE  )(.*)(?= )"
}

disconnect() {
    old_connection="$(active_connection)"
    if [ -n "$old_connection" ]; then
        nmcli connection down "$old_connection" && 
            info "disconnected $old_connection"
    else
        error "could not disconnect \"$old_connection\""
    fi
}

info "status: $(status)"
if [ "$(status)" = "connected" ] && testnet > /dev/null 2>&1; then
    info "connected to: $(active_connection)"
    exit 0
else
    disconnect
fi

while IFS= read -r line; do
    [ "$(status)" = "connected" ] && break
    (echo "$line" | grep -Pq '^(#.*|\s*)$') && continue
    id="$line"
    info "connecting to \"$id\"..."
    timeout 5s nmcli connection up id "$id"
done < "$WIFI_LIST_FILE"

if [ "$(status)" = "connected" ] && testnet > /dev/null 2>&1; then
    info "successfully connected to $(active_connection)"
else
    error "could not connect"
    exit 1
fi
