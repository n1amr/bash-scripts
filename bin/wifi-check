#!/bin/bash

source ~/.dotfiles_config

WIFI_LIST_FILE="$DOTFILES_HOME/data/wifi-list"
[ -f "$WIFI_LIST_FILE" ] || echo "# Enter wifi SSID list here" > "$WIFI_LIST_FILE"

DEVICE="$(nmcli dev | grep wifi | cut -d ' ' -f 1)"

status() {
    nmcli d | grep "$DEVICE" | grep -Po '\S*connected'
}

disconnect() {
    old_connection="$(nmcli --fields DEVICE,NAME con show --active | grep -Po "(?<=$DEVICE  )(.*)(?= )")"
    [ -n "$old_connection" ] && nmcli connection down "$old_connection"
}

[ "$(status)" = "connected" ] && testnet > /dev/null 2>&1 || disconnect

while IFS= read -r line; do
    [ "$(status)" = "connected" ] && break
    (echo "$line" | grep -Pq '^(#.*|\s*)$') && continue
    id="$line"
    echo "connecting to $id..."
    timeout 5s nmcli connection up id "$id"
done < "$WIFI_LIST_FILE"
