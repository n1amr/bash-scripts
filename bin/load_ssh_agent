#!/bin/bash

if [ ! -z "$SSH_AUTH_SOCK" ] && nc -z -U "$SSH_AUTH_SOCK" > /dev/null 2>&1; then
    # Agent socket is already running
    return
fi

if [ -d "$HOME/.ssh/" ]; then
    mkdir "$HOME/.ssh"
    chmod 700 "$HOME/.ssh"
fi

SSH_ENV="$HOME/.ssh/environment"

[ "$1" = "--add" ] && add=true

start_new_agent() {
    ssh-agent | sed 's/^echo/#echo/' > "$SSH_ENV"
    chmod 600 "$SSH_ENV"
    . "$SSH_ENV" > /dev/null
    [ "$add" = 'true' ] && ssh-add
}

if [ -f "$SSH_ENV" ]; then
    . "$SSH_ENV" > /dev/null
fi

if [ -z "$SSH_AUTH_SOCK" ] || ! nc -z -U "$SSH_AUTH_SOCK" > /dev/null 2>&1; then
    start_new_agent
fi
