#!/bin/bash

set -e

source ~/.dotfiles_config
source "$DOTFILES_HOME/bin/lib/log"
source "$DOTFILES_HOME/bin/lib/lock" --verbose

if [ -z "$DOTFILES_CONFIG_YOUTUBE_HOME" ]; then
    echo -n 'Enter youtube home directory: '
    read -r DOTFILES_CONFIG_YOUTUBE_HOME
    echo "export DOTFILES_CONFIG_YOUTUBE_HOME='$DOTFILES_CONFIG_YOUTUBE_HOME'" >> ~/.dotfiles_config
fi

YOUTUBE_DOWNLADER="$PYENV_ROOT/shims/youtube-dl"
YOUTUBE_HOME="$DOTFILES_CONFIG_YOUTUBE_HOME"

TARGET_DIR=''
PLAYLIST_ID=''
while [[ $# -gt 0 ]]; do
    if [[ -z "$PLAYLIST_ID" ]]; then
        PLAYLIST_ID="$1"
    elif [[ -z "$TARGET_DIR" ]]; then
        TARGET_DIR="$1"
    else
        echo "Usage: youtube-dl-playlist PLAYLIST_ID [TARGET_DIR]"
        exit 1
    fi
    shift
done

if [[ -z "$PLAYLIST_ID" ]]; then
    echo "Error: You must pass the playlist id"
    exit 1
fi

if [[ -z "$TARGET_DIR" ]]; then
    TARGET_DIR="$(dirname "${BASH_SOURCE[0]}")"
fi
TARGET_DIR="$(realpath "$TARGET_DIR")"

PLAYLIST_URL="https://youtube.com/playlist?list=$PLAYLIST_ID"
COOKIE_FILE="$YOUTUBE_HOME/.youtube-dl/cookies.txt"
LOCK_FILE="$YOUTUBE_HOME/.youtube-dl/lock"; export LOCK_FILE
ARCHIVE_FILE="$TARGET_DIR/.download_archive"
DEFAULT_OUTPUT_TEMPLATE='%(playlist_index)s - %(title)s - (@%(uploader)s - %(id)s).%(ext)s'
OUTPUT_TEMPLATE="${OUTPUT_TEMPLATE:-$DEFAULT_OUTPUT_TEMPLATE}"

cd "$YOUTUBE_HOME"
if [ ! -d .youtube-dl ]; then
    mkdir .youtube-dl
fi

if [ ! -f "$COOKIE_FILE" ]; then
    echo "Please copy cookies.txt to $COOKIE_FILE"
    exit 1
fi

ARGS=()
ARGS+=(-f 18)
ARGS+=(--sub-lang en,ar --write-auto-sub --convert-subs srt)
ARGS+=(--continue --ignore-errors)
ARGS+=(--mark-watched)
ARGS+=(--cookie "$COOKIE_FILE")
ARGS+=(--download-archive "$ARCHIVE_FILE")
ARGS+=(-o "$OUTPUT_TEMPLATE")
ARGS+=("$PLAYLIST_URL")

echo "Target directory: $TARGET_DIR"
echo "Playlist url: $PLAYLIST_URL"
echo "Command: $YOUTUBE_DOWNLADER ${ARGS[@]}"

cd "$TARGET_DIR"
"$YOUTUBE_DOWNLADER" "${ARGS[@]}"
