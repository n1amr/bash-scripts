#!/bin/bash

set -e

source ~/.dotfiles.env
source "$DOTFILES_HOME/bin/lib/log"
source "$DOTFILES_HOME/bin/lib/lock" --verbose

if [ -z "$DOTFILES_CONFIG_YOUTUBE_HOME" ]; then
    echo -n 'Enter youtube home directory: '
    read -r DOTFILES_CONFIG_YOUTUBE_HOME
    echo "export DOTFILES_CONFIG_YOUTUBE_HOME='$DOTFILES_CONFIG_YOUTUBE_HOME'" >> ~/.dotfiles.env
fi

YOUTUBE_DOWNLADER="$PYENV_ROOT/shims/youtube-dl"
YOUTUBE_HOME="$DOTFILES_CONFIG_YOUTUBE_HOME"

OUTPUT_DIR=''
URL=''
FORMAT='18'
FLAG_REVERSE=''
FLAG_NO_COOKIES=''
while [[ $# -gt 0 ]]; do
    if [[ -z "$URL" ]]; then
        URL="$1"
    elif [[ -z "$OUTPUT_DIR" ]]; then
        OUTPUT_DIR="$1"
    elif [[ "$1" == '-f' ]]; then
        shift
        FORMAT="$1"
    elif [[ "$1" == '--reverse' ]]; then
        FLAG_REVERSE='true'
    elif [[ "$1" == '--no-cookies' ]]; then
        FLAG_NO_COOKIES='true'
    else
        echo >&2 "Usage: youtube-dl-playlist URL [OUTPUT_DIR] [-f <FORMAT>] [--reverse] [--no-cookies]"
        exit 1
    fi
    shift
done

if [[ -z "$URL" ]]; then
    echo >&2 "Error: You must pass the playlist url"
    exit 1
fi

if [[ -z "$OUTPUT_DIR" ]]; then
    OUTPUT_DIR="$(dirname "${BASH_SOURCE[0]}")"
fi
OUTPUT_DIR="$(realpath "$OUTPUT_DIR")"

COOKIE_FILE="$YOUTUBE_HOME/.youtube-dl/cookies.txt"
LOCK_FILE="$YOUTUBE_HOME/.youtube-dl/lock"; export LOCK_FILE
ARCHIVE_FILE="$OUTPUT_DIR/.download_archive"
DEFAULT_OUTPUT_TEMPLATE='%(playlist_index)s - %(title)s - (@%(uploader)s - %(id)s).%(ext)s'
OUTPUT_TEMPLATE="${OUTPUT_TEMPLATE:-$DEFAULT_OUTPUT_TEMPLATE}"

if [ ! -d "$YOUTUBE_HOME/.youtube-dl" ]; then
    mkdir "$YOUTUBE_HOME/.youtube-dl"
fi

if [ ! -f "$COOKIE_FILE" ] && [ "$FLAG_NO_COOKIES" != 'true' ]; then
    echo >&2 "Please copy cookies.txt to $COOKIE_FILE or use option --no-cookies"
    exit 1
fi

ARGS=()
ARGS+=(-f "$FORMAT")
[[ "$FLAG_REVERSE" == 'true' ]] && ARGS+=(--playlist-reverse)
[[ "$FLAG_NO_COOKIES" != 'true' ]] && ARGS+=(--cookie "$COOKIE_FILE")
ARGS+=(--sub-lang en,ar --write-auto-sub --convert-subs srt)
ARGS+=(--continue --ignore-errors)
ARGS+=(--mark-watched)
ARGS+=(--download-archive "$ARCHIVE_FILE")
ARGS+=(-o "$OUTPUT_TEMPLATE")
ARGS+=("$URL")

echo "Output directory: $OUTPUT_DIR"
echo "URL: $PLAYLIST_URL"
echo "Command: $YOUTUBE_DOWNLADER ${ARGS[@]}"

cd "$OUTPUT_DIR"
"$YOUTUBE_DOWNLADER" "${ARGS[@]}"
