#!/bin/bash

source ~/.dotfiles_config
if [ -z "$DOTFILES_CONFIG_VPN_HOME" ]; then
    echo -n 'Enter vpn home directory: '
    read DOTFILES_CONFIG_VPN_HOME
    echo "export DOTFILES_CONFIG_VPN_HOME='$DOTFILES_CONFIG_VPN_HOME'" >> ~/.dotfiles_config
fi

VPN_HOME="$DOTFILES_CONFIG_VPN_HOME"

credentials_file="$VPN_HOME/credentials/current"
selected_profile="$VPN_HOME/profiles/$(cat $VPN_HOME/profiles/current)"

source ~/.dotfiles_config
UPDATEVPN_SCRIPT="$DOTFILES_HOME/bin/updatevpn"

connect () {
    sudo openvpn --config "${selected_profile}" --auth-user-pass "${credentials_file}";
}

connect && successful=1

if [ "$successful" != 1 ]; then
    echo "Connection failed!!!"
    echo -n "Update credentials? [y/n]: "
    read response;
    if [ x"$response" == x"y" ]; then "${UPDATEVPN_SCRIPT}"; connect; fi
fi
source ~/.dotfiles_config
if [ -z "$DOTFILES_CONFIG_VPN_HOME" ]; then
    echo -n 'Enter vpn home directory: '
    read DOTFILES_CONFIG_VPN_HOME
    echo "export DOTFILES_CONFIG_VPN_HOME='$DOTFILES_CONFIG_VPN_HOME'" >> ~/.dotfiles_config
fi

VPN_HOME="$DOTFILES_CONFIG_VPN_HOME"
