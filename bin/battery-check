#!/bin/bash

set -e

beep='paplay /usr/share/sounds/ubuntu/stereo/message-new-instant.ogg'
battery='upower -i /org/freedesktop/UPower/devices/battery_BAT0| grep -E "state|to\ empty|percentage"'


state () {
    eval "$battery" | grep 'state' | awk '{print $2}'
}

battery_percentage () {
    eval "$battery" | grep 'percentage' | awk '{print $2}' | awk -F '%' '{print $1}'
}

recheck () {
    [ "$(state)" == 'discharging' ] || exit
}


# Get the integer percentage of current battery capacity
p="$(battery_percentage)"

run_beep () {
    for i in {10..0}; do
        for _ in {0..3}; do
            eval "$beep" &
            k="$i"
            while [ "$k" -gt 0 ]; do
                sleep 0.05
                k="$(( k - 1 ))"
            done
        done
        recheck
    done

    for i in {0..3}; do
        eval "$beep"
        recheck
    done
}

if [ "$p" -le 150 ] && [ "$(state)" == 'discharging' ]; then
    run_beep &
    sleep 30

    recheck
    sudo pm-hibernate
fi
