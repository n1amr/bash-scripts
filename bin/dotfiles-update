#!/bin/bash

set -e

CURRENT_DOTFILES="$(realpath "$(dirname "$0")/..")"
branch='master'

for dir in "$CURRENT_DOTFILES" "$CURRENT_DOTFILES/custom"; do (
        echo ">> cd $dir"
        cd "$dir"

        echo ">> git add ."
        git add .

        echo ">> git stash -u"
        git stash -u

        echo ">> git checkout -f $branch"
        git checkout -f "$branch"

        echo ">> git add ."
        git add .

        echo ">> git stash -u"
        git stash -u

        echo ">> git fetch origin"
        git fetch origin

        echo ">> git reset --hard origin/$branch"
        git reset --hard "origin/$branch"

        echo ">> git pull origin $branch --rebase --recurse-submodules -j16"
        git pull origin "$branch" --rebase --recurse-submodules -j16 ||
            git pull origin "$branch" --rebase --recurse-submodules

        echo ">> git checkout -f -"
        git checkout -f -

        echo ">> git submodule update --init --recursive"
        git submodule update --init --recursive

        echo ">> git submodule foreach --recursive 'git checkout -f $branch'"
        git submodule foreach --recursive "git checkout -f \"$branch\""

        echo ">> git submodule update --init --recursive"
        git submodule update --init --recursive

        # echo ">> git stash apply"
        # git stash apply
); done

echo ">> $CURRENT_DOTFILES/bin/marks update"
"$CURRENT_DOTFILES/bin/marks" update

echo ">> exec ${SHELLNAME:-$SHELL}"
exec "${SHELLNAME:-$SHELL}"
